<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>區網檔案傳輸 | FileHub</title>

    <!-- Google Fonts: Inter -->
    <!-- Local Fonts: Inter -->
    <link href="{{ url_for('static', filename='css/fonts.css') }}" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>

<body>
    <div class="container">
        <header class="mb-4 text-center">
            <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 1rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none"
                    stroke="url(#gradient-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <defs>
                        <linearGradient id="gradient-primary" x1="0" y1="0" x2="1" y2="1">
                            <stop offset="0%" stop-color="#3b82f6" />
                            <stop offset="100%" stop-color="#10b981" />
                        </linearGradient>
                    </defs>
                    <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"></path>
                    <path d="M12 12v9"></path>
                    <path d="m16 16-4-4-4 4"></path>
                </svg>
                <h1>區網檔案傳輸</h1>
            </div>
            <p class="text-muted">安全、快速的局域網檔案分享服務</p>
        </header>

        {% if marquee_text %}
        <div class="marquee-container mb-4">
            <div class="marquee-content">
                {{ marquee_text }}
            </div>
        </div>
        {% endif %}

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                {% if category == 'success' %}
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                {% else %}
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                {% endif %}
                <span>{{ message }}</span>
            </div>
            <button type="button" class="btn-close" onclick="this.parentElement.style.display='none'">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <!-- Upload Card -->
        <div class="card">
            <div class="card-header">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                上傳檔案
            </div>
            <div class="card-body">
                <form action="{{ url_for('web.upload_file_web') }}" method="post" enctype="multipart/form-data">
                    <div class="input-group">
                        <input type="file" class="form-control" name="files" id="fileInput" multiple required>
                        <button type="submit" class="btn btn-primary">
                            <span>開始上傳</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <polyline points="19 12 12 19 5 12"></polyline>
                            </svg>
                        </button>
                    </div>
                    <small class="form-text mt-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            style="display:inline; vertical-align:text-bottom">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                            <line x1="8" y1="21" x2="16" y2="21"></line>
                            <line x1="12" y1="17" x2="12" y2="21"></line>
                        </svg>
                        按住 <strong>Ctrl</strong> 或 <strong>Command</strong> 鍵可選取多個檔案
                    </small>

                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-glass);">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="checkbox" id="enableProtection"
                                onchange="document.getElementById('passwordField').style.display = this.checked ? 'block' : 'none'">
                            <label for="enableProtection" style="cursor: pointer; user-select: none;">啟用密碼保護</label>
                        </div>
                        <div id="passwordField" style="display: none;">
                            <input type="password" name="protection_password" class="form-control"
                                placeholder="請設定保護密碼 (選填)" autocomplete="new-password">
                            <small class="text-muted"
                                style="display: block; margin-top: 0.25rem;">設定後，下載或刪除檔案時需輸入此密碼。</small>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Files List Card -->
        <div class="card">
            <div class="card-header">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                檔案列表
            </div>
            <div class="card-body">
                {% if files %}
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col" style="width: 40%">
                                    <a href="{{ url_for('web.index', sort='name', order='desc' if current_sort == 'name' and current_order == 'asc' else 'asc') }}"
                                        style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 0.25rem;">
                                        檔名
                                        {% if current_sort == 'name' %}
                                        {% if current_order == 'asc' %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path d="m18 15-6-6-6 6" />
                                        </svg>
                                        {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path d="m6 9 6 6 6-6" />
                                        </svg>
                                        {% endif %}
                                        {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.3">
                                            <path d="m7 15 5 5 5-5" />
                                            <path d="m7 9 5-5 5 5" />
                                        </svg>
                                        {% endif %}
                                    </a>
                                </th>
                                <th scope="col" style="width: 25%">
                                    <a href="{{ url_for('web.index', sort='date', order='desc' if current_sort == 'date' and current_order == 'asc' else 'asc') }}"
                                        style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 0.25rem;">
                                        上傳時間
                                        {% if current_sort == 'date' %}
                                        {% if current_order == 'asc' %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path d="m18 15-6-6-6 6" />
                                        </svg>
                                        {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path d="m6 9 6 6 6-6" />
                                        </svg>
                                        {% endif %}
                                        {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.3">
                                            <path d="m7 15 5 5 5-5" />
                                            <path d="m7 9 5-5 5 5" />
                                        </svg>
                                        {% endif %}
                                    </a>
                                </th>
                                <th scope="col" style="width: 15%">
                                    <a href="{{ url_for('web.index', sort='size', order='desc' if current_sort == 'size' and current_order == 'asc' else 'asc') }}"
                                        style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 0.25rem;">
                                        大小
                                        {% if current_sort == 'size' %}
                                        {% if current_order == 'asc' %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path d="m18 15-6-6-6 6" />
                                        </svg>
                                        {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path d="m6 9 6 6 6-6" />
                                        </svg>
                                        {% endif %}
                                        {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.3">
                                            <path d="m7 15 5 5 5-5" />
                                            <path d="m7 9 5-5 5 5" />
                                        </svg>
                                        {% endif %}
                                    </a>
                                </th>
                                <th scope="col" class="text-end">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in files %}
                            <tr>
                                <td class="align-middle">
                                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                                            viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                                            <polyline points="13 2 13 9 20 9"></polyline>
                                        </svg>
                                        <div style="display: flex; flex-direction: column;">
                                            <span style="font-weight: 500; word-break: break-all;">{{ file.original_name
                                                }}</span>
                                            {% if file.has_password %}
                                            <small
                                                style="color: var(--primary); display: flex; align-items: center; gap: 0.25rem;">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12"
                                                    viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                                </svg>
                                                密碼保護
                                            </small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td class="align-middle text-muted">{{ file.upload_time }}</td>
                                <td class="align-middle text-muted">{{ file.formatted_size }}</td>
                                <td class="text-end">
                                    <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
                                        <a href="#"
                                            onclick="initiateDownload('{{ file.stored_name }}', {{ 'true' if file.has_password else 'false' }}); return false;"
                                            class="btn btn-success btn-sm" title="下載">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                                <polyline points="7 10 12 15 17 10"></polyline>
                                                <line x1="12" y1="15" x2="12" y2="3"></line>
                                            </svg>
                                            下載
                                        </a>
                                        <button class="btn btn-danger btn-sm"
                                            onclick="initiateDelete('{{ file.stored_name }}', '{{ file.original_name }}', {{ 'true' if file.has_password else 'false' }});"
                                            title="刪除">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                <path
                                                    d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                                </path>
                                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                                <line x1="14" y1="11" x2="14" y2="17"></line></button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center" style="padding: 3rem 0;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                        stroke="#334155" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                        style="margin-bottom: 1rem;">
                        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                        <polyline points="13 2 13 9 20 9"></polyline>
                    </svg>
                    <p class="text-muted">目前沒有任何檔案，請上傳。</p>
                </div>
                {% endif %}
            </div>
        </div>

        <footer>
            <div style="display: flex; justify-content: center; align-items: center; gap: 0.5rem;">
                <span>Powered by</span>
                <span style="color: var(--primary); font-weight: 600;">Gemini</span>
                <span>&</span>
                <span style="color: var(--text-main); font-weight: 600;">Flask</span>
            </div>
            <div class="text-center mt-2">
                <small style="opacity: 0.7;">UI/UX Pro Max Edition</small>
            </div>
        </footer>
    </div>

    <!-- Password Verification Modal -->
    <div id="passwordModal" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h3>檔案受保護</h3>
                <button class="btn-close-modal" onclick="closePasswordModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p>此檔案受密碼保護，請輸入密碼以繼續。</p>
                <div class="form-group">
                    <input type="password" id="modalPasswordInput" class="form-control" placeholder="輸入密碼"
                        onkeypress="if(event.key === 'Enter') submitPassword()">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePasswordModal()">取消</button>
                <button class="btn btn-primary" onclick="submitPassword()">確認</button>
            </div>
        </div>
    </div>

    <script>
        let currentAction = null; // 'download' or 'delete'
        let currentStoredName = null;
        let currentOriginalName = null;

        function initiateDownload(storedName, hasPassword) {
            if (!hasPassword) {
                window.location.href = "{{ url_for('web.download_file', stored_name='PLACEHOLDER') }}".replace('PLACEHOLDER', storedName);
                return;
            }
            currentAction = 'download';
            currentStoredName = storedName;
            openPasswordModal();
        }

        function initiateDelete(storedName, originalName, hasPassword) {
            currentStoredName = storedName;
            currentOriginalName = originalName;

            if (!hasPassword) {
                if (confirm(`您確定要刪除檔案 '${originalName}' 嗎？`)) {
                    // Create and submit form for delete
                    submitDynamicForm("{{ url_for('web.delete_file_route', stored_name='PLACEHOLDER') }}".replace('PLACEHOLDER', storedName));
                }
                return;
            }

            currentAction = 'delete';
            openPasswordModal();
        }

        function openPasswordModal() {
            document.getElementById('passwordModal').style.display = 'flex';
            document.getElementById('modalPasswordInput').value = '';
            document.getElementById('modalPasswordInput').focus();
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            currentAction = null;
            currentStoredName = null;
            currentOriginalName = null;
        }

        function submitPassword() {
            const password = document.getElementById('modalPasswordInput').value;
            if (!password) {
                alert('請輸入密碼');
                return;
            }

            let url = '';
            if (currentAction === 'download') {
                url = "{{ url_for('web.download_file', stored_name='PLACEHOLDER') }}".replace('PLACEHOLDER', currentStoredName);
            } else if (currentAction === 'delete') {
                url = "{{ url_for('web.delete_file_route', stored_name='PLACEHOLDER') }}".replace('PLACEHOLDER', currentStoredName);
            }

            if (currentAction === 'delete') {
                if (!confirm(`您確定要刪除檔案 '${currentOriginalName}' 嗎？`)) {
                    return;
                }
            }

            submitDynamicForm(url, { password: password });
            closePasswordModal();
        }

        function submitDynamicForm(url, data = {}) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = url;
            form.style.display = 'none';

            for (const key in data) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = data[key];
                form.appendChild(input);
            }

            document.body.appendChild(form);
            form.submit();
        }

        // Close modal on outside click
        window.onclick = function (event) {
            const modal = document.getElementById('passwordModal');
            if (event.target == modal) {
                closePasswordModal();
            }
        }
    </script>
</body>

</html>